<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>マテリアルポイント作成</title>
	<style>
		.hidden{display:none}
		.acol{border:1px solid #d7cce7;background-color:#e4dcf0;}
		.colpick{color:#8973a8}
		.pointer:hover{cursor:pointer}
		.inline-block{display:inline-block}
		.purple{color:#8973a8}
		.hover-purple:hover .purple{color:#7d35d4}
		.hover-purple:hover svg{fill:#7d35d4}
		.invisible{visibility:invisible}
		.prep1{min-width:100px}
		.prep2{min-width:140px}
		#filecontent,#filecontent_sncond{min-height:100px;font-family:monospace}
		#mpRadiusRange{width:200px}
	</style>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
	<style>
		.btn-outline-primary {
			color: #8e65c7;
			border-color: #8e65c7;
		}
		.btn-outline-primary:hover {
			color: #fff;
			background-color: #8e65c7;
			border-color: #8e65c7;
		}
		.btn-outline-primary:focus, .btn-outline-primary.focus {
			box-shadow: 0 0 0 0.2rem rgba(100, 53, 166, 0.5);
		}
		.btn-outline-primary.disabled, .btn-outline-primary:disabled {
			color: #8e65c7;
			background-color: transparent;
		}
	</style>
</head>
<body>
	<div class="container pb-4">
		<h1 class="mt-4 mb-4">正方形格子用・等間隔マテリアルポイント作成</h1>
		<div class="row">
			<div class="pointer col-sm pt-1 acol hover-purple" id="toggler-addMP">
				<div title="マテリアルポイント追加" >
					<div class="inline-block purple">マテリアルポイント追加</div>
					<svg height="40" viewBox="0 0 16 16" class="bi bi-plus" fill="#8973a8" xmlns="http://www.w3.org/2000/svg">
						<path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
					</svg>
				</div>
			</div>
			<div class="pointer col-sm pt-1 acol hover-purple" id="toggler-addNCOND">
				<div title="境界条件追加" >
					<div class="inline-block purple">境界条件追加</div>
					<svg height="40" viewBox="0 0 16 16" class="bi bi-plus" fill="#8973a8" xmlns="http://www.w3.org/2000/svg">
						<path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
					</svg>
				</div>
			</div>
			<div class="col-sm pt-1 invisible">
			</div>
		</div>
		<div id="toggle-addMP" class="hidden">
			<div class="row mt-4">
				<div class="col-sm acol pt-2">
					<div class="purple mb-2">マテリアルポイントの座標から入力</div>
				</div>
				<div class="col-sm acol pt-2">
					<div class="purple mb-2">格子の情報から入力</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm pt-3 pb-3 acol">
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep1">材料番号</span>
						</div>
						<input type="text" class="form-control" placeholder="例：1" id="MPmat-fromXY">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep1">始点XY</span>
						</div>
						<input type="text" class="form-control" placeholder="例：0.25" id="MPx1-fromXY">
						<input type="text" class="form-control" placeholder="例：0.25" id="MPy1-fromXY">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep1">終点XY</span>
						</div>
						<input type="text" class="form-control" placeholder="例：11.75" id="MPx2-fromXY">
						<input type="text" class="form-control" placeholder="例：26.75" id="MPy2-fromXY">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep1">間隔</span>
						</div>
						<input type="text" class="form-control" placeholder="例：0.50" id="MPinterval-fromXY">
					</div>
					<input class="btn btn-outline-primary" type="button" value="適用" id="submit-addMP-fromXY">
				</div>
				<div class="col-sm pt-3 pb-3 acol">
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep2">材料番号</span>
						</div>
						<input type="text" class="form-control" placeholder="例：1" id="MPmat-fromGrid">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep2">格子の始点XY</span>
						</div>
						<input type="text" class="form-control" placeholder="例：0.00" id="MPx1-fromGrid">
						<input type="text" class="form-control" placeholder="例：0.00" id="MPy1-fromGrid">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep2">格子の終点XY</span>
						</div>
						<input type="text" class="form-control" placeholder="例：12.00" id="MPx2-fromGrid">
						<input type="text" class="form-control" placeholder="例：27.00" id="MPy2-fromGrid">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep2">格子幅</span>
						</div>
						<input type="text" class="form-control" placeholder="例：1.0" id="MPgridWidth-fromGrid">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text prep2">格子内MP数</span>
						</div>
						<input type="text" class="form-control" placeholder="例：4" id="MPnumInGrid-fromGrid">
					</div>
					<input class="btn btn-outline-primary" type="button" value="適用" id="submit-addMP-fromGrid">
				</div>
			</div>
		</div>
		<div id="toggle-addNCOND" class="hidden">
			<div class="row mt-4">
				<div class="col-sm pt-3 pb-3 acol">
					<div class="purple mb-2">境界条件の追加</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text" id="basic-addon1">始点XY</span>
						</div>
						<input type="text" class="form-control" placeholder="例：1.00" id="ncond_x1">
						<input type="text" class="form-control" placeholder="例：1.00" id="ncond_y1">
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text" id="basic-addon1">終点XY</span>
						</div>
						<input type="text" class="form-control" placeholder="例：1.00" id="ncond_x2">
						<input type="text" class="form-control" placeholder="例：26.00" id="ncond_y2">
					</div>
					<div>
						<input type="radio" value="sncond_x" name="sncond_fix" id="sncond_x">
						<label class="pointer" for="sncond_x">X固定</label>
						<input class="ml-3" type="radio" value="sncond_y" name="sncond_fix" id="sncond_y">
						<label class="pointer" for="sncond_y">Y固定</label>
						<input class="ml-3" type="radio" value="sncond_xy" name="sncond_fix" id="sncond_xy">
						<label class="pointer" for="sncond_xy">XY固定</label>
					</div>
					<input class="btn btn-outline-primary" type="button" value="適用" id="submit-addNCOND">
				</div>
				<div class="col-sm pt-3 acol"></div>
			</div>
		</div>
		
		<div>
			<div class="purple mb-2 mt-3">マテリアルポイント(input_mp.dat) 内容</div>
			<textarea class="form-control" placeholder="ファイル内容はここに表示されます" id="filecontent" onclick="this.focus();this.select()" readonly="readonly"></textarea>
			<input class="btn btn-outline-primary mt-2" type="button" value="input_mp.datを保存" id="savefile">
		</div>
		
		<div class="mt-4">
			<div class="purple mb-2">境界条件(config.datの一部) 内容</div>
			<textarea class="form-control" placeholder="ファイル内容はここに表示されます" id="filecontent_sncond" onclick="this.focus();this.select()" readonly="readonly"></textarea>
		</div>
		
		
		<div class="mt-4 purple">プレビュー</div>
		
		<div class="form-group ml-2">
			<label for="formControlRange" class="purple mt-2">MP表示ピクセル数: <span id="mpRadiusPx">2</span>px</label>
			<input type="range" class="form-control-range pointer" id="mpRadiusRange" min="0" max="7" value="1">
		</div>
		<div id="MPcanvas-wrapper" class="mt-3" style="position:absolute">
			<div id="MPcanvas" width="100px" height="100px"></div>
		</div>
		<div min-height="200px" id="MPbackground"></div>
	</div>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
	<script src="js/mp.js"></script>
	<script src="js/debug.js"></script>
	<script src="js/io.js"></script>
	<script src="js/ncond.js"></script>
	<script src="js/mp_canvas.js"></script>
	<script type="text/javascript">
		$(function(){
			initLS()
			$("#toggler-addMP").on('click', function(){
				$("#toggle-addMP").toggleClass("hidden")
				$("#toggle-addNCOND").addClass("hidden")
			});
			$("#toggler-addNCOND").on('click', function(){
				$("#toggle-addMP").addClass("hidden")
				$("#toggle-addNCOND").toggleClass("hidden")
			});
			$("#submit-addMP-fromXY").on('click', function(){
				let mm = parseInt($("#MPmat-fromXY").val())
				let x1 = parseFloat($("#MPx1-fromXY").val())
				let y1 = parseFloat($("#MPy1-fromXY").val())
				let x2 = parseFloat($("#MPx2-fromXY").val())
				let y2 = parseFloat($("#MPy2-fromXY").val())
				let interval = parseFloat($("#MPinterval-fromXY").val())
				addMP_fromXY(mm,x1,y1,x2,y2,interval)
				convert()
				drawRect()
			});
			$("#submit-addMP-fromGrid").on('click', function(){
				let mm = parseInt($("#MPmat-fromGrid").val())
				let x1 = parseFloat($("#MPx1-fromGrid").val())
				let y1 = parseFloat($("#MPy1-fromGrid").val())
				let x2 = parseFloat($("#MPx2-fromGrid").val())
				let y2 = parseFloat($("#MPy2-fromGrid").val())
				let gridWidth = parseFloat($("#MPgridWidth-fromGrid").val())
				let numInGrid = parseInt($("#MPnumInGrid-fromGrid").val())
				addMP_fromGrid(mm,x1,y1,x2,y2,gridWidth,numInGrid)
				convert()
				drawRect()
			});
			$("#savefile").on('click',function(){
				saveAsFile("input_mp.dat",$("#filecontent").text())
			})
			$("#submit-addNCOND").on('click', function(){
				let x1 = parseFloat($("#ncond_x1").val())
				let y1 = parseFloat($("#ncond_y1").val())
				let x2 = parseFloat($("#ncond_x2").val())
				let y2 = parseFloat($("#ncond_y2").val())
				let fix = $("input[name=sncond_fix]:checked").val()
				addNCOND(x1,y1,x2,y2,fix)
				convertNcond()
				drawRect()
			})
			$("#mpRadiusRange").on('change', function(){
				setRadius($(this).val())
				if (MPcount > 0){
					drawRect()
				}
				localStorage.setItem("mpRadiusRange",$(this).val()+"")
			})
		});
		
		function initLS(){
			$("input[type=text]").each(function(event, elem){
				if (elem.hasAttribute("id")){
					$(elem).on('change', function(ev2){
						let id = $(ev2.target).attr("id")
						let val = $(ev2.target).val()
						localStorage.setItem(id, val)
					});
					let ls = localStorage.getItem($(elem).attr("id"))
					if (ls) {
						$(elem).val(ls)
					}
				}
			})
			$("input[type=radio]").each(function(event, elem){
				if (elem.hasAttribute("name")){
					$(elem).on('change', function(ev2){
						let name = $(ev2.target).attr("name")
						let val = $("input[name="+name+"]:checked").val()
						localStorage.setItem(name, val)
					});
					//無駄に三海実行されるけどまあいいや
					let ls = localStorage.getItem($(elem).attr("name"))
					if (ls) {
						$(elem).val([ls])
					}
				}
			})
			let lvalRad = localStorage.getItem("mpRadiusRange")
			if (lvalRad) {
				$("#mpRadiusRange").val(parseInt(lvalRad))
				setRadius(parseInt(lvalRad))
			}
		}
		
		function convert(){
			let content = ""
			for (let i = 0; i < MPtree.length; i++){
				let id = MPtree[i].id
				let x = MPtree[i].x
				let y = MPtree[i].y
				let mm = MPtree[i].mm
				let iid = indentify_int(id,5)
				let ix = indentify_float(x,5,10)
				let iy = indentify_float(y,5,10)
				let imm = indentify_int(mm,5)
				let line = iid+ix+iy+imm+"\n"
				content += line
			}
			$("#filecontent").text(content)
		}

		function convertNcond(){
			let content = ""
			for (let i = 0; i < ncond.length; i++){
				let x1 = ncond[i].x1
				let y1 = ncond[i].y1
				let x2 = ncond[i].x2
				let y2 = ncond[i].y2
				let xfix = ncond[i].xfix
				let yfix = ncond[i].yfix
				let ix1 = indentify_float(x1,5,10)
				let iy1 = indentify_float(y1,5,10)
				let ix2 = indentify_float(x2,5,10)
				let iy2 = indentify_float(y2,5,10)
				let ixfix = indentify_int(xfix,5)
				let iyfix = indentify_int(yfix,5)
				let line = ix1+ix2+iy1+iy2+ixfix+iyfix+"\n"
				content += line
			}
			$("#filecontent_sncond").text(content)
		}
	</script>
</body>
</html>