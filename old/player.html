<!DOCTYPE html>
<html>
<head>
<title>nicol;st - playl;st</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
<style type="text/css">
	.silent {display: none}
	body{background-color: #112;padding: 1em 2em;margin: 0;color: #ddd;}
	button{cursor: pointer;}
	.disabled {cursor: default;}
</style>
</head>
<body onload="init();">
	<h1>nicol;st player</h1>
	<div id="play"></div>
	<div id="controller">
		<div>
			<button class="btn btn-outline-secondary mb-1 mt-1 disabled silent" type="submit" onclick="if (!$(this).hasClass('disabled')) {previous();}" id="pcprev">前の動画へ</button>
			<button class="btn btn-outline-secondary mb-1 mt-1 disabled silent" type="submit" onclick="if (!$(this).hasClass('disabled')) {next();}" id="pcnext">次の動画へ</button>
		</div>
	</div>
	<div class="silent ml-2 mt-4" id="noquery">
		<p>プレイリスト情報がないため動画は再生されません。</p>
		<div><button class="btn btn-outline-secondary mb-1 mt-1 silent" type="submit" onclick="restore()" id="pcrestore">前回のプレイリストを復元して再生</button></div>
	</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<!-- Youtube iframe api-->
<script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
<script type="text/javascript">
var playlist = [];
var _playlist_string = '';
var playindex = 0;

function init(){
	var infoarray = window.location.search.match(/[^?&]+=[^?&]*/g);

	if (infoarray === null){
		$('#noquery').removeClass('silent');

		var l = localStorage.getItem('nicolist_playlist_s');
		if (l){
			var ml = l.match(/[^?&]+=[^?&]*/g);
			if (ml){
				$('#pcrestore').removeClass('silent');
			}
		}
		return;
	}

	for (var i = 0; i < infoarray.length; i++) {
		var m = infoarray[i].match(/^pl=([^?&]+)$/);
		if (m) {
			try {
				playlist = JSON.parse(unescape(m[1]));
				_playlist_string = m[1];
			} catch(e) {
				$('#play').text(e);
				return;
			}
		} else {
			var m2 = infoarray[i].match(/^i=(\d+)$/);
			if (m2) {
				playindex = parseInt(m2[1], 10);
			}
		}
	}

	if (!(playlist instanceof Array) || playlist.length === 0){
		$('#play').text('プレイリスト情報が不正です。');
		return;
	}

	if (playlist.length <= playindex || playindex < 0) playindex = 0;

	refreshController();
	createEmbedElem(playlist[playindex]);

	savePlaylistData();
}
	
var autoplay = false;
function createEmbedElem(id){
	$('#pcnext').removeClass('silent');
	$('#pcprev').removeClass('silent');
	if ((new RegExp("^sm\\d+$")).test(id)|| (new RegExp("^nm\\d+$")).test(id) || (new RegExp("^so\\d+$")).test(id) || (new RegExp("^\\d+$")).test(id)){
		setupNiconicoIframe(id);
	} else {
		setupYoutubeIframe(id);
	}
}
var player;
function setupYoutubeIframe(id){
	$('#play').html('');
	var div = $('<div>',{
		"id": "playeriframeyoutube",
	});
	var s = videoSize();
	$('#play').append(div);
	player = new YT.Player('playeriframeyoutube', {
		width: s[0],
		height: s[1],
		videoId: id,
		playerVars: { 'autoplay': (autoplay ? 1 : 0)},
		events: {
			'onStateChange': function(event){
				if (event.data === YT.PlayerState.ENDED){
					autoplay = true;
					next();
				} else if (autoplay && event.data === YT.PlayerState.CUED){
					player.playVideo();
					autoplay = false;
				}
			}
		}
	});
}
function setupNiconicoIframe(id){
	$('#play').html('');
	var s = videoSize();
	var iframeElement = $('<iframe>',{
		"id": "playeriframenicovideo",
		"width": s[0]+"",
		"height": s[1]+"",
		"src": 'https://embed.nicovideo.jp/watch/'+id+'?jsapi=1&playerId='+playindex,
		"frameborder": "0",
		"allow": "autoplay; encrypted-media",
		"allowfullscreen": ""
	});
	$('#play').append(iframeElement);
	window.addEventListener('message', function (event) {
		if (event.origin === 'https://embed.nicovideo.jp'){
			if (event.data.eventName === 'playerStatusChange'){
				if (event.data.data.playerStatus === 4){
					autoplay = true;
					next();
				}
			} else if (autoplay && event.data.eventName === 'loadComplete'){
				$('#play iframe').get(0).contentWindow.postMessage({eventName:'play',playerId:playindex+"",sourceConnectorType:1}, 'https://embed.nicovideo.jp');
				autoplay = false;
			}
		}
	});
}
function next(){
	if (hasNext()){
		playindex++;
		var id = playlist[playindex];
		if ((new RegExp("^sm\\d+$")).test(id)|| (new RegExp("^nm\\d+$")).test(id) || (new RegExp("^so\\d+$")).test(id) || (new RegExp("^\\d+$")).test(id)){
			if (!$('#play iframe').length || $('#play iframe').attr('id') === 'playeriframeyoutube'){
				setupNiconicoIframe(id);
			} else {
				$('#play iframe').attr('src', 'https://embed.nicovideo.jp/watch/'+id+'?jsapi=1&playerId='+(playindex));
			}
		} else {
			if (!$('#play iframe').length || $('#play iframe').attr('id') === 'playeriframenicovideo'){
				setupYoutubeIframe(id);
			} else {
				player.cueVideoById({videoId: id});
			}
		}
		refreshController();
		savePlaylistData();
	}
}
function hasNext(){
	return playindex !== -1 && playlist.length > playindex + 1;
}
function hasPrevious(){
	return playindex > 0;
}
function previous(){
	if (hasPrevious()){
		playindex--;
		var id = playlist[playindex];
		if ((new RegExp("^sm\\d+$")).test(id)|| (new RegExp("^nm\\d+$")).test(id) || (new RegExp("^so\\d+$")).test(id) || (new RegExp("^\\d+$")).test(id)){
			if (!$('#play iframe').length || $('#play iframe').attr('id') === 'playeriframeyoutube'){
				setupNiconicoIframe(id);
			} else {
				$('#play iframe').attr('src', 'https://embed.nicovideo.jp/watch/'+id+'?jsapi=1&playerId='+(playindex));
			}
		} else {
			if (!$('#play iframe').length || $('#play iframe').attr('id') === 'playeriframenicovideo'){
				setupYoutubeIframe(id);
			} else {
				player.loadVideoById({videoId: id});
			}
		}
		refreshController();
		savePlaylistData();
	}
}
function refreshController(){
	if (hasNext()){
		if ($('#pcnext').hasClass('disabled')){
			$('#pcnext').removeClass('disabled');
		}
	} else {
		if (!$('#pcnext').hasClass('disabled')){
			$('#pcnext').addClass('disabled');
		}
	}
	if (hasPrevious()){
		if ($('#pcprev').hasClass('disabled')){
			$('#pcprev').removeClass('disabled');
		}
	} else {
		if (!$('#pcprev').hasClass('disabled')){
			$('#pcprev').addClass('disabled');
		}
	}
}
function savePlaylistData(){
	localStorage.setItem('nicolist_playlist_s', 'pl='+_playlist_string+'&i='+playindex);
}
$(window).resize(function() {
	videoResize();
});
function videoSize(){
	var w = $('#play').innerWidth();
	var h = Math.ceil(w * 9 / 16);
	return [w, h];
}
function videoResize(){
	var s = videoSize();
	$('#play iframe').css({
		'width': s[0],
		'height': s[1]
	});
}
function restore(){
	var l = localStorage.getItem('nicolist_playlist_s');
	if (l){
		var m = l.match(/^pl=([^?&]+)&i=(\d+)$/);
		if (m && m.length > 2){
			playlist = JSON.parse(unescape(m[1]));
			playindex = parseInt(m[2], 10);

			refreshController();
			createEmbedElem(playlist[playindex]);

			$('#noquery').addClass('silent');
		}
	}
}
</script>
</body>
</html>