<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>3DCG Platfrom - 3次元MPMの可視化</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
	<style>
		#alert{position:fixed;bottom:1em;left:1em}
		#mp{background-color:transparent}
		.pointer{cursor:pointer}
		#mp{font-family:monospace;font-size:.7em;min-height:7em}
		.green-800{color:rgb(10,54,34);}
		.wrapper {position :relative;min-width:1000px;min-height:800px;}
		.wrapper > canvas{position: absolute;}
		#alertbox {position: fixed;bottom:20px;right:20px;z-index:1}
		.hidden {display: none;}
	</style>
</head>
<body>
	<div class="m-4">
		<h1>3DCG Platform</h1>
		<div class="row">
			<div class="col pt-3">
				<div class="wrapper">
					<canvas class="border" width="1000px" height="800px" id="canvas"></canvas>
					<canvas class="" width="1000px" height="800px" id="canvas_webgl"></canvas>
				</div>
			</div>
			<div class="col pt-3">
				<div class="mb-2"><span class="badge bg-success"><span id="ms"></span> ms / 1frame</span></div>
				<button type="button" class="btn btn-outline-primary" id="getCamInfo">カメラ情報を取得</button>
				<div class="mt-2" id="caminfo"></div>
				<div>
					<table class="table">
						<tr><td>GPU Vender</td><td id="gpuvender">-</td></tr>
						<tr><td>GPU Info</td><td id="gpuinfo">-</td></tr>
					</table>
				</div>
			</div>
			<div class="col pt-3">
				<div>
					操作:
					<span class="badge bg-secondary" id="keyw">W</span>
					<span class="badge bg-secondary" id="keya">A</span>
					<span class="badge bg-secondary" id="keys">S</span>
					<span class="badge bg-secondary" id="keyd">D</span>
					<span class="badge bg-secondary" id="keyc">C</span>
					<span class="badge bg-secondary" id="keyspace">space</span>
				</div>
				<div class="mt-2">
					<button type="button" class="btn btn-outline-primary" id="resetCam">カメラ位置をリセット</button>
				</div>
				<div class="form-check form-switch mt-2">
					<input class="form-check-input pointer" type="checkbox" id="zrot">
					<label class="form-check-label pointer" for="zrot">Z軸回転</label>
				</div>
				<div class="form-check form-switch mt-1">
					<input class="form-check-input pointer" type="checkbox" id="dg">
					<label class="form-check-label pointer" for="dg">デバッググリッドを非表示</label>
				</div>
				<div class="mt-1 row">
					<div class="col-4">
						<label for="particle_size" class="form-label">Particle Size:</label><span class="m-2" id="particle_size_display">2</span>
					</div>
					<div class="col">
						<input type="range" class="form-range" id="particle_size" value="20">
					</div>
				</div>
				<div class="input-group mt-3">
					<label class="input-group-text" for="inputmp">インプットファイルを読み込む</label>
					<input type="file" class="form-control" id="inputmp">
				</div>
				<div class="mt-2">
					<button type="button" class="btn btn-outline-primary" id="vtk_inputfile">VTKファイルとして出力(temp)</button>
				</div>
			</div>
		</div>
		<div id="alertbox"></div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/1.0.30/encoding.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/gpu.js@latest/dist/gpu-browser.js"></script>
	<script src="js3d/util.js"></script>
	<script src="js3d/components.js"></script>
	<script src="js3d/read_formated_text_util.js"></script>
	<script src="js3d/mp_gpu.js"></script>
	<script src="js3d/vtk.js"></script>
	<script type="text/javascript">
	///////control///////
	var drawing = false
	var drawfirst = true
	var x_0, y_0
	var debuggrid = true
	var keyW = false
	var keyA = false
	var keyS = false
	var keyD = false
	var keyC = false
	var keySpace = false
	var zrotate = false
	function onMouseDown(e) {
		drawing = true
		drawfirst = true
	}
	function onMouseUp() {
		drawing = false
		drawfirst = true
	}
	function onMousemove(e) {
		if (drawing){
			if (!drawfirst){
				let dx = e.layerX - x_0
				let dy = e.layerY - y_0
				
				if (dx !== 0) {
					sys.rot(new Vec3d(0,0,1), -dx * 3.1416/1000)
				} 
				if (dy !== 0) {
					sys.rot(sys.e_xi, -dy * 3.1416/1000)
				} 
				
				window.requestAnimationFrame(draw)
			} else {
				drawfirst = false
			}
			x_0 = e.layerX
			y_0 = e.layerY
		}
	}
	function onWheel(e){
		sys.zoom *= (1000 - e.deltaY) / 1000
		window.requestAnimationFrame(draw)
		e.preventDefault()
	}
	function onKeyDown(e){
		let dirty = false
		let pressedBefore = keyW || keyS || keyA || keyD || keyC || keySpace
		if (!keyW && e.key === "w") {keyW = true; dirty=true;$("#keyw").addClass("bg-primary").removeClass("bg-secondary")}
		if (!keyA && e.key === "a") {keyA = true; dirty=true;$("#keya").addClass("bg-primary").removeClass("bg-secondary")}
		if (!keyS && e.key === "s") {keyS = true; dirty=true;$("#keys").addClass("bg-primary").removeClass("bg-secondary")}
		if (!keyD && e.key === "d") {keyD = true; dirty=true;$("#keyd").addClass("bg-primary").removeClass("bg-secondary")}
		if (!keyC && e.key === "c") {keyC = true; dirty=true;$("#keyc").addClass("bg-primary").removeClass("bg-secondary")}
		if (!keySpace && e.key === " ") {keySpace = true; dirty=true;$("#keyspace").addClass("bg-primary").removeClass("bg-secondary")}
		if (dirty) e.preventDefault()
		if (!pressedBefore && dirty) keytik()
	}
	function onKeyUp(e){
		if (e.key === "w") {keyW = false;$("#keyw").removeClass("bg-primary").addClass("bg-secondary")}
		if (e.key === "a") {keyA = false;$("#keya").removeClass("bg-primary").addClass("bg-secondary")}
		if (e.key === "s") {keyS = false;$("#keys").removeClass("bg-primary").addClass("bg-secondary")}
		if (e.key === "d") {keyD = false;$("#keyd").removeClass("bg-primary").addClass("bg-secondary")}
		if (e.key === "c") {keyC = false;$("#keyc").removeClass("bg-primary").addClass("bg-secondary")}
		if (e.key === " ") {keySpace = false;$("#keyspace").removeClass("bg-primary").addClass("bg-secondary")}
	}
	function keytik(){
		if (keyW) {
			sys.cam = sys.cam.plus(sys.ec, 10)
			sys.rs = sys.rs.plus(sys.ec, 10)
		}
		if (keyS) {
			sys.cam = sys.cam.plus(sys.ec, -10)
			sys.rs = sys.rs.plus(sys.ec, -10)
		}
		if (keyA) {
			sys.cam = sys.cam.plus(sys.e_xi, -10)
			sys.rs = sys.rs.plus(sys.e_xi, -10)
		}
		if (keyD) {
			sys.cam = sys.cam.plus(sys.e_xi, 10)
			sys.rs = sys.rs.plus(sys.e_xi, 10)
		}
		if (keyC) {
			sys.cam = sys.cam.plus(new Vec3d(0,0,1), -10)
			sys.rs = sys.rs.plus(new Vec3d(0,0,1), -10)
		}
		if (keySpace) {
			sys.cam = sys.cam.plus(new Vec3d(0,0,1), 10)
			sys.rs = sys.rs.plus(new Vec3d(0,0,1), 10)
		}
		if (keyW || keyS || keyA || keyD || keyC || keySpace){
			window.requestAnimationFrame(draw)
			setTimeout(keytik, 20)
		}
	}
	function rotate(){
		if (!zrotate) return
		sys.rot(new Vec3d(0,0,1), 0.025)
		setTimeout(rotate, 16)
		window.requestAnimationFrame(draw)
	}
	
	///////init///////
	const canvas = document.getElementById('canvas')
	const sys = new CameraSystem(canvas.width, canvas.height)
	const ctx = canvas.getContext('2d')
	
	///////objects///////
	const grid = new DebugGrid()
	var mps
	var radius = 2.0;

	//read_formated_text_util.js
	const reader = new FormatReader("X10,3F11,I11", (data)=>{
		mps = new Float32Array(data)
		main();
	})
	
	///////main///////
	function draw(){
		const startTime = performance.now()
		if (gl) drawScene()

		if (debuggrid) {
			ctx.clearRect(0, 0, canvas.width, canvas.height)
			grid.draw(ctx, sys)
			//$("#getCamInfo").trigger("click")
		}

		const endTime = performance.now();
		$("#ms").text(Math.ceil(10*(endTime-startTime))/10+"")
	}
	
	///////onload///////
	$(function(){
		$("#vtk_inputfile").on("click", function(e){
			if (mps){
				saveAsVTK(mps)
			}
		})
		$("#particle_size").on("change", function(e){
			radius = parseInt($(e.target).val()/10)
			$("#particle_size_display").text(radius+"")
			window.requestAnimationFrame(draw)
		})
		$("#inputmp").on("change", function(e){
			reader.read(e.target.files[0])
		})
		$("#resetCam").on("click", function(){
			sys.reset()
			window.requestAnimationFrame(draw)
		})
		$("#zrot").on("change", function(){
			if ($("#zrot").prop("checked")){
				zrotate = true
				rotate()
			} else {
				zrotate = false
			}
		})
		$("#dg").on("change", function(){
			if ($("#dg").prop("checked")){
				debuggrid = false
				ctx.clearRect(0, 0, canvas.width, canvas.height)
			} else {
				debuggrid = true
			}
			window.requestAnimationFrame(draw)
		})
		$("#getCamInfo").on("click", function(){
			let _text = "<table class='table'>"
			_text += "<tr><td><b>R</b><sub>c</sub></td><td>"+ sys.cam  .toString()+"</td></tr>"
			_text += "<tr><td><b>e</b><sub>ξ</sub></td><td>"+ sys.e_xi .toString()+"</td></tr>"
			_text += "<tr><td><b>e</b><sub>η</sub></td><td>"+ sys.e_eta.toString()+"</td></tr>"
			_text += "<tr><td><b>e</b><sub>c</sub></td><td>"+ sys.ec   .toString()+"</td></tr>"
			_text += "<tr><td><b>R</b><sub>s</sub></td><td>"+ sys.rs   .toString()+"</td></tr>"
			_text += "<tr><td>Z<sub>c</sub></td><td>"+ numToStr(sys.zoom)+"</td></tr></table>"
			$("#caminfo").html(_text)
		})
		canvas_webgl.addEventListener('mousedown', onMouseDown, false)
		canvas_webgl.addEventListener('mouseup', onMouseUp, false)
		canvas_webgl.addEventListener('mousemove', onMousemove, false)
		canvas_webgl.addEventListener('wheel', onWheel, false)
		canvas_webgl.setAttribute('tabindex', 0)
		canvas_webgl.addEventListener('keydown', onKeyDown, false)
		canvas_webgl.addEventListener('keyup', onKeyUp, false)
		window.requestAnimationFrame(draw)
		$("#getCamInfo").trigger("click")
	})
	</script>
</body>
</html>